# ふるさと納税シミュレーター実装サマリー

## 実装完了日
2025-11-16

## Phase 1 (MVP v0.5) 完了状況

### 実装された機能

#### 1. 簡易版シミュレーター
- **場所**: `/src/features/simulator`
- **ファイル構成**:
  - `ui/SimulatorForm.tsx` - フォームコンポーネント
  - `ui/SimulatorResult.tsx` - 結果表示コンポーネント
  - `lib/simulatorSchema.ts` - バリデーションスキーマ (Zod)
  - `lib/calculateLimit.ts` - 控除額計算ロジック
- **入力項目**:
  - 年収（万円単位）: 100万円〜3000万円
  - 配偶者の有無
  - 扶養家族の人数: 0〜10人
- **計算方式**: 
  - 令和2年以降の給与所得控除を使用
  - 社会保険料は年収の14.4%で推定
  - 基礎控除: 48万円（所得2400万円以下の場合）
  - 配偶者控除: 38万円
  - 扶養控除: 38万円/人
  - 所得税率: 7段階の累進課税
  - 復興特別所得税: 所得税額の2.1%
  - 住民税所得割額の計算（所得税率 - 5%で簡易計算）
  - 控除上限額 = (住民税所得割額 × 20%) / (90% - 所得税率 × 1.021) + 2,000円

#### 2. 詳細版シミュレーター（NEW）
- **場所**: `/src/features/simulator`
- **ファイル構成**:
  - `ui/DetailedSimulatorForm.tsx` - 詳細フォームコンポーネント
  - `lib/detailedSimulatorSchema.ts` - 詳細版バリデーションスキーマ
  - `lib/calculateDetailedLimit.ts` - 詳細計算ロジック
- **入力項目（すべて実装済み）**:

##### 基本情報
- 年収（万円単位）
- 配偶者の有無
- 配偶者の年収（万円単位）- 配偶者特別控除計算用
- 都道府県（将来の自治体別税率対応用）

##### 扶養親族（年齢区分別）
- 一般の扶養親族（16-18歳、23-69歳）: 38万円/人
- 特定扶養親族（19-22歳）: 63万円/人
- 老人扶養親族（70歳以上・別居）: 48万円/人
- 老人扶養親族（70歳以上・同居）: 58万円/人

##### 障害者控除
- 本人: なし / 障害者（27万円）/ 特別障害者（40万円）
- 配偶者: なし / 障害者（27万円）/ 特別障害者（40万円）/ 同居特別障害者（75万円）
- 扶養親族:
  - 障害者の人数: 27万円/人
  - 特別障害者の人数: 40万円/人
  - 同居特別障害者の人数: 75万円/人

##### その他の人的控除
- 寡婦控除: 27万円
- ひとり親控除: 35万円
- 勤労学生控除: 27万円

##### 所得控除
- 社会保険料控除（円単位）: 未入力時は年収の14.4%で推定
- iDeCo・小規模企業共済等掛金控除（円単位）
- 生命保険料控除（円単位）: 最大12万円
- 地震保険料控除（円単位）: 最大5万円
- 医療費控除（円単位）
- 寄付金控除（円単位、ふるさと納税以外）

##### 税額控除
- 住宅ローン控除（円単位）: 所得税計算後に適用

#### 3. UI実装
- **タブ切り替え**: shadcn/ui の Tabs コンポーネント使用
  - 簡易版タブ
  - 詳細版タブ
  - タブ切り替え時に結果をリセット
- **レイアウト**: 
  - 左側: フォーム
  - 右側: 結果表示
  - レスポンシブ対応（lg:grid-cols-2）
- **フォームセクション構成**（詳細版）:
  1. 基本情報
  2. 扶養親族
  3. 障害者控除
  4. その他の人的控除
  5. 所得控除
  6. 税額控除

#### 4. ページ構成
- **メインページ**: `/src/app/simulator/page.tsx`
- **共通コンポーネント**: 
  - `SimulatorResult.tsx` - 簡易版・詳細版で共通使用
- **フッター情報**: 
  - 簡易版と詳細版の説明
  - 会員登録不要
  - 会員登録のメリット案内

## 技術スタック

### フレームワーク・ライブラリ
- **Next.js**: 16.0.3 (App Router, Turbopack)
- **TypeScript**: 5.9.3
- **React**: 19.0.0
- **Zod**: 4.x (バリデーション)
- **React Hook Form**: 7.x (フォーム管理)
- **shadcn/ui**: UIコンポーネント（New York スタイル）
  - Button, Card, Input, Label, Select, Tabs

### 実装パターン
- **Client Components**: "use client" を使用（フォーム、インタラクティブ要素）
- **型安全性**: Zod スキーマから TypeScript 型を生成（z.infer）
- **バリデーション**: zodResolver でフォームとスキーマを統合
- **条件付きレンダリング**: watch() で配偶者の有無などを監視

## 計算ロジックの詳細

### 給与所得控除（令和2年以降）
```
年収162.5万円以下: 55万円
年収162.5万円超180万円以下: 年収 × 40% - 10万円
年収180万円超360万円以下: 年収 × 30% + 8万円
年収360万円超660万円以下: 年収 × 20% + 44万円
年収660万円超850万円以下: 年収 × 10% + 110万円
年収850万円超: 195万円
```

### 配偶者特別控除（詳細版）
- 配偶者の合計所得金額に応じて控除額が変動
- 本人の所得金額によっても控除額が変動
- 配偶者の給与収入103万円超201万円以下の範囲で適用

### 所得税率（7段階）
```
195万円以下: 5%
195万円超330万円以下: 10% - 97,500円
330万円超695万円以下: 20% - 427,500円
695万円超900万円以下: 23% - 636,000円
900万円超1,800万円以下: 33% - 1,536,000円
1,800万円超4,000万円以下: 40% - 2,796,000円
4,000万円超: 45% - 4,796,000円
```

### 住民税
- 所得割: 課税所得 × 10%
- 調整控除: 基礎控除等の差額を調整（最低2,500円）
- 復興特別所得税: 所得税額の2.1%

## 改善履歴

### 1. 計算精度の向上（初期実装後）
- **変更前**: 簡易的な係数ベースの計算
- **変更後**: 実際の税制に基づいた詳細計算
- **commit**: `0369df2` feat: improve simulator calculation accuracy with tax-based formula

### 2. UX改善（年収入力単位変更）
- **変更前**: 円単位で入力（例: 5000000）
- **変更後**: 万円単位で入力（例: 500）
- **対象ファイル**: 
  - `simulatorSchema.ts`: バリデーション範囲を1,000,000-30,000,000 → 100-3000に変更
  - `calculateLimit.ts`: `annualIncome * 10000` で円に変換
  - `SimulatorForm.tsx`: ラベル・プレースホルダー・単位表示を変更
- **commit**: `b6c8b78` refactor: change annual income input to 万円 unit for better UX

### 3. 詳細版シミュレーター追加
- **commit**: `6098c6e` feat: add detailed simulator with comprehensive tax deduction support
- 全控除項目を網羅
- タブUIで簡易版と切り替え可能

### 4. 詳細版フィールド完全化
- **commit**: `492fae6` feat: add all missing fields to detailed simulator
- 都道府県選択追加
- 障害者控除セクション追加（本人・配偶者・扶養親族）
- その他の人的控除セクション追加（寡婦・ひとり親・勤労学生）

## ディレクトリ構造

```
src/
├── app/
│   └── simulator/
│       └── page.tsx          # メインページ（タブUI）
├── features/
│   └── simulator/
│       ├── ui/
│       │   ├── SimulatorForm.tsx           # 簡易版フォーム
│       │   ├── DetailedSimulatorForm.tsx   # 詳細版フォーム
│       │   └── SimulatorResult.tsx         # 結果表示（共通）
│       └── lib/
│           ├── simulatorSchema.ts          # 簡易版スキーマ
│           ├── detailedSimulatorSchema.ts  # 詳細版スキーマ
│           ├── calculateLimit.ts           # 簡易版計算
│           └── calculateDetailedLimit.ts   # 詳細版計算
├── components/
│   └── ui/
│       └── tabs.tsx          # shadcn/ui Tabs コンポーネント
└── shared/
    └── config/
        └── prefectures.ts    # 都道府県マスター（47都道府県）
```

## 今後の拡張可能性

### データ管理機能（Phase 2以降）
- シミュレーション結果の保存
- 過去のシミュレーション履歴
- お気に入り自治体の登録
- 寄付記録の管理

### 計算精度の向上
- 都道府県別の住民税率対応
- 市区町村別の住民税率対応
- より詳細な控除項目の追加

### UX改善
- 入力値の保存（localStorage）
- CSVエクスポート
- PDF出力
- グラフ表示

## 注意事項

### 現在未使用の項目
- **都道府県**: スキーマには含まれているが、計算ロジックでは未使用
  - 将来的に自治体ごとの税率差を反映予定

### 推定値を使用している項目
- **社会保険料**: 未入力時は年収の14.4%で推定
- **配偶者の年収**: 未入力時は103万円以下と仮定

### バリデーション範囲
- 年収: 100万円〜3000万円
- 配偶者の年収: 0万円〜201万円（201万円超は配偶者特別控除対象外）
- 扶養家族・扶養親族: 各カテゴリーで最大10人
- 生命保険料控除: 最大12万円
- 地震保険料控除: 最大5万円
- 住宅ローン控除: 最大50万円
